(()=>{class t{constructor(t){this.element=t,this.config={postType:t.dataset.postType,postsPerPage:parseInt(t.dataset.postsPerPage),columns:parseInt(t.dataset.columns),orderBy:t.dataset.orderBy,order:t.dataset.order,showFeaturedImage:"1"===t.dataset.showFeaturedImage,showExcerpt:"1"===t.dataset.showExcerpt,showDate:"1"===t.dataset.showDate,showAuthor:"1"===t.dataset.showAuthor},this.grid=t.querySelector(".filterable-grid-block__grid"),this.gridWrapper=t.querySelector(".filterable-grid-block__grid-wrapper"),this.loading=t.querySelector(".filterable-grid-block__loading"),this.pagination=t.querySelector(".filterable-grid-block__pagination"),this.searchInput=t.querySelector(".filterable-grid-block__search-input"),this.filterSelects=t.querySelectorAll(".filterable-grid-block__filter-select"),this.sortSelect=t.querySelector(".filterable-grid-block__sort-select"),this.resultsCount=t.querySelector(".filterable-grid-block__results-count"),this.activeFiltersContainer=t.querySelector(".filterable-grid-block__active-filters"),this.activeFiltersList=t.querySelector(".filterable-grid-block__active-filters-list"),this.clearFiltersBtn=t.querySelector(".filterable-grid-block__clear-filters"),this.currentPage=1,this.searchTimeout=null,this.activeFilters={},this.searchQuery="",this.isLoading=!1,this.init()}init(){if(this.searchInput){this.searchInput.addEventListener("input",t=>{clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.searchQuery=t.target.value,this.currentPage=1,this.fetchPosts()},500)});const t=this.element.querySelector(".filterable-grid-block__search-button");t&&t.addEventListener("click",()=>{this.searchQuery=this.searchInput.value,this.currentPage=1,this.fetchPosts()}),this.searchInput.addEventListener("keypress",t=>{"Enter"===t.key&&(t.preventDefault(),clearTimeout(this.searchTimeout),this.searchQuery=this.searchInput.value,this.currentPage=1,this.fetchPosts())})}this.filterSelects.forEach(t=>{t.addEventListener("change",t=>{const e=t.target.dataset.taxonomy,s=t.target.value;s?this.activeFilters[e]={termId:s,termName:t.target.options[t.target.selectedIndex].text.split(" (")[0]}:delete this.activeFilters[e],this.currentPage=1,this.updateActiveFiltersDisplay(),this.fetchPosts()})}),this.sortSelect&&this.sortSelect.addEventListener("change",t=>{const[e,s]=t.target.value.split("-");this.config.orderBy=e,this.config.order=s,this.currentPage=1,this.fetchPosts()}),this.element.addEventListener("click",t=>{const e=t.target.closest(".page-numbers");if(e&&!e.classList.contains("current")){if(t.preventDefault(),e.classList.contains("prev"))this.currentPage--;else if(e.classList.contains("next"))this.currentPage++;else{const t=e.textContent.trim();this.currentPage=parseInt(t)}this.fetchPosts(),this.scrollToTop()}}),this.clearFiltersBtn&&this.clearFiltersBtn.addEventListener("click",()=>{this.clearAllFilters()}),this.element.addEventListener("click",t=>{if(t.target.closest(".filterable-grid-block__active-filter-remove")){t.preventDefault();const e=t.target.closest(".filterable-grid-block__active-filter-remove").dataset.taxonomy;this.removeFilter(e)}})}async fetchPosts(){if(this.isLoading)return;this.showLoading(),this.isLoading=!0;const t=new FormData;t.append("action","filter_grid_posts"),t.append("nonce",filterableGridData.nonce),t.append("post_type",this.config.postType),t.append("posts_per_page",this.config.postsPerPage),t.append("paged",this.currentPage),t.append("search",this.searchQuery),t.append("orderby",this.config.orderBy),t.append("order",this.config.order),t.append("show_featured_image",this.config.showFeaturedImage?"1":"0"),t.append("show_excerpt",this.config.showExcerpt?"1":"0"),t.append("show_date",this.config.showDate?"1":"0"),t.append("show_author",this.config.showAuthor?"1":"0"),Object.entries(this.activeFilters).forEach(([e,s])=>{t.append(`filters[${e}]`,s.termId)});try{const e=await fetch(filterableGridData.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=await e.json();s.success?(this.updateGrid(s.data),this.updatePagination(s.data),this.updateResultsCount(s.data),this.updateURL()):(console.error("Error fetching posts:",s),this.showError())}catch(t){console.error("Error fetching posts:",t),this.showError()}finally{this.hideLoading(),this.isLoading=!1}}updateGrid(t){this.grid.style.opacity="0",setTimeout(()=>{this.grid.innerHTML=t.html,requestAnimationFrame(()=>{this.grid.style.opacity="1"}),this.element.dispatchEvent(new CustomEvent("gridUpdated",{detail:{foundPosts:t.found_posts,postCount:t.post_count,currentPage:t.current_page}}))},200)}updatePagination(t){this.pagination&&(t.max_pages<=1?this.pagination.style.display="none":(this.pagination.style.display="block",this.pagination.innerHTML=t.pagination_html,this.pagination.dataset.maxPages=t.max_pages,this.pagination.dataset.currentPage=t.current_page))}updateResultsCount(t){if(!this.resultsCount)return;const e=t.found_posts>0?this.getResultsMessage(t.post_count,t.found_posts):this.getNoResultsMessage();this.resultsCount.textContent=e}getResultsMessage(t,e){return window.wp&&window.wp.i18n?wp.i18n.sprintf(wp.i18n.__("Showing %d of %d results","mytheme"),t,e):`Showing ${t} of ${e} results`}getNoResultsMessage(){return window.wp&&window.wp.i18n?wp.i18n.__("No results found","mytheme"):"No results found"}updateActiveFiltersDisplay(){if(!this.activeFiltersContainer||!this.activeFiltersList)return;if(0===Object.keys(this.activeFilters).length)return void(this.activeFiltersContainer.style.display="none");this.activeFiltersContainer.style.display="flex";const t=Object.entries(this.activeFilters).map(([t,e])=>`\n                <span class="filterable-grid-block__active-filter">\n                    <span class="filterable-grid-block__active-filter-label">\n                        ${this.getTaxonomyLabel(t)}:\n                    </span>\n                    <span class="filterable-grid-block__active-filter-value">\n                        ${this.escapeHtml(e.termName)}\n                    </span>\n                    <button type="button" \n                            class="filterable-grid-block__active-filter-remove" \n                            data-taxonomy="${t}"\n                            aria-label="${this.getRemoveFilterLabel(e.termName)}">\n                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">\n                            <path d="M9 3L3 9M3 3L9 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n                        </svg>\n                    </button>\n                </span>\n            `).join("");this.activeFiltersList.innerHTML=t}getTaxonomyLabel(t){const e=this.element.querySelector(`[data-taxonomy="${t}"]`);if(!e)return t;const s=e.querySelector("option:first-child");return s?s.textContent:t}getRemoveFilterLabel(t){return window.wp&&window.wp.i18n?wp.i18n.sprintf(wp.i18n.__("Remove filter: %s","mytheme"),t):`Remove filter: ${t}`}removeFilter(t){delete this.activeFilters[t];const e=this.element.querySelector(`[data-taxonomy="${t}"]`);e&&(e.value=""),this.currentPage=1,this.updateActiveFiltersDisplay(),this.fetchPosts()}clearAllFilters(){this.activeFilters={},this.searchQuery="",this.currentPage=1,this.filterSelects.forEach(t=>{t.value=""}),this.searchInput&&(this.searchInput.value=""),this.sortSelect&&(this.sortSelect.value=`${this.element.dataset.orderBy}-${this.element.dataset.order}`,this.config.orderBy=this.element.dataset.orderBy,this.config.order=this.element.dataset.order),this.updateActiveFiltersDisplay(),this.fetchPosts()}updateURL(){if(!window.history||!window.history.pushState)return;const t=new URL(window.location),e=t.searchParams;["page","s","orderby","order"].forEach(t=>e.delete(t)),Object.keys(this.activeFilters).forEach(t=>e.delete(t)),this.currentPage>1&&e.set("page",this.currentPage),this.searchQuery&&e.set("s",this.searchQuery),this.config.orderBy===this.element.dataset.orderBy&&this.config.order===this.element.dataset.order||(e.set("orderby",this.config.orderBy),e.set("order",this.config.order)),Object.entries(this.activeFilters).forEach(([t,s])=>{e.set(t,s.termId)}),window.history.pushState({},"",t.toString())}showLoading(){this.loading&&(this.loading.hidden=!1),this.gridWrapper&&this.gridWrapper.classList.add("is-loading"),this.setInteractiveState(!0)}hideLoading(){this.loading&&(this.loading.hidden=!0),this.gridWrapper&&this.gridWrapper.classList.remove("is-loading"),this.setInteractiveState(!1)}setInteractiveState(t){this.searchInput&&(this.searchInput.disabled=t),this.filterSelects.forEach(e=>{e.disabled=t}),this.sortSelect&&(this.sortSelect.disabled=t)}showError(){const t=this.getErrorMessage();this.grid.innerHTML=`\n            <div class="filterable-grid-block__error">\n                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n                    <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="2"/>\n                    <path d="M24 14V26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n                    <circle cx="24" cy="32" r="1.5" fill="currentColor"/>\n                </svg>\n                <p>${t}</p>\n                <button type="button" class="filterable-grid-block__retry-button">\n                    ${this.getRetryButtonText()}\n                </button>\n            </div>\n        `;const e=this.grid.querySelector(".filterable-grid-block__retry-button");e&&e.addEventListener("click",()=>{this.fetchPosts()})}getErrorMessage(){return window.wp&&window.wp.i18n?wp.i18n.__("Something went wrong while loading posts. Please try again.","mytheme"):"Something went wrong while loading posts. Please try again."}getRetryButtonText(){return window.wp&&window.wp.i18n?wp.i18n.__("Retry","mytheme"):"Retry"}scrollToTop(){const t=this.element.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:t,behavior:"smooth"})}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}initFromURL(){const t=new URL(window.location).searchParams,e=t.get("page");e&&(this.currentPage=parseInt(e));const s=t.get("s");s&&this.searchInput&&(this.searchQuery=s,this.searchInput.value=s);const i=t.get("orderby"),r=t.get("order");i&&r&&(this.config.orderBy=i,this.config.order=r,this.sortSelect&&(this.sortSelect.value=`${i}-${r}`)),this.filterSelects.forEach(e=>{const s=e.dataset.taxonomy,i=t.get(s);if(i){e.value=i;const t=e.options[e.selectedIndex].text.split(" (")[0];this.activeFilters[s]={termId:i,termName:t}}}),Object.keys(this.activeFilters).length>0&&this.updateActiveFiltersDisplay(),(e||s||i||Object.keys(this.activeFilters).length>0)&&this.fetchPosts()}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".filterable-grid-block").forEach(e=>{const s=new t(e);e.filterableGridInstance=s})}),window.FilterableGrid=t})();